// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Source {
  id        String    @id @default(cuid())
  name      String
  url       String    @unique
  type      String // RSS or TELEGRAM
  isActive  Boolean   @default(true)
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  articles  Article[]

  @@index([type])
  @@index([isActive])
}

model Article {
  id          String   @id @default(cuid())
  title       String
  url         String   @unique
  content     String   @db.Text
  publishedAt DateTime
  sourceId    String
  source      Source   @relation(fields: [sourceId], references: [id], onDelete: Cascade)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Mediametrics метрики
  views           Int      @default(0)
  forwards       Int      @default(0)
  reactions      Int      @default(0)
  replies        Int      @default(0)
  rating         Float    @default(0) // Динамический рейтинг по формуле Mediametrics
  ratingUpdatedAt DateTime @default(now())

  // Поля для динамики рейтинга
  previousRating   Float    @default(0)    // Рейтинг на прошлом обновлении
  previousPosition Int      @default(0)    // Позиция на прошлом обновлении
  currentPosition  Int      @default(0)    // Текущая позиция
  positionChange   Int      @default(0)    // Изменение позиции (shift)
  ratingDelta      Float    @default(0)    // Изменение рейтинга
  firstSeenAt      DateTime @default(now()) // Когда впервые попала в рейтинг

  @@index([sourceId])
  @@index([publishedAt])
  @@index([rating])
  @@index([ratingUpdatedAt])
  @@index([currentPosition])
  @@index([publishedAt, rating])
}

model RatingSettings {
  id          String   @id @default(cuid())
  key         String   @unique // 'default' - единственные настройки
  name        String   @default("Rating Formula Settings")
  
  // Веса для формулы рейтинга
  viewsWeight      Float @default(0.05)   // Views × 0.05
  forwardsWeight   Float @default(8.0)    // Forwards × 8
  reactionsWeight  Float @default(3.0)    // Reactions × 3
  repliesWeight    Float @default(5.0)    // Replies × 5
  agePenalty       Float @default(2.0)    // Age × 2 (штраф за старость в часах)
  
  // Дополнительные настройки
  minRating        Float? @default(0)     // Минимальный рейтинг (null = без ограничения)
  maxAgeHours      Int?                   // Максимальный возраст статьи в часах (null = без ограничения)
  
  // Метаданные
  description      String? @db.Text
  updatedBy        String?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@index([key])
}
